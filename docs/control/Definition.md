# Control 目录代码与算法说明

本文档解释 Control 目录下路径跟踪控制器的坐标系、误差定义和控制逻辑。

## 坐标系定义

- **车头方向**：x 正方向为车头前进方向。
- **左侧/右侧**：y 正方向为车头左侧，y 负方向为车头右侧。
- **航向**：轨迹中的 yaw（航向角）始终指向车头方向，无论前进或倒车。
- **速度方向**：前进为正（>0），倒车为负（<0）。
- **曲率/半径方向**：往左为正（>0），往右为负（<0）。
- **转角请求 (delta)**：前轮转向角，往左为正（>0），往右为负（<0）。

## 误差定义

### 横向误差 (ed)

- **定义**：车辆当前位置到参考轨迹的垂直距离。
- **符号**：车辆在轨迹左侧时为正（>0），右侧时为负（<0）。无论前进或倒车，定义一致。
- **单位**：米。

### 航向误差 (e_phi)

- **定义**：车辆航向与参考轨迹切线方向的夹角。
- **符号**：车头朝着轨迹正方向左侧时为正（>0），右侧时为负（<0）。
- **单位**：弧度。

## 控制逻辑

### 横向误差控制

横向误差校正遵循"偏左右打，偏右左打"的原则：

| 速度方向 | 横向误差 ($e_d$) | 转向输出 ($\delta$) | 控制效果 |
| -------- | ------------------ | --------------------- | -------- |
| 前进     | $e_d > 0$ (偏左) | $\delta < 0$ (右打) | 向右拉回 |
| 前进     | $e_d < 0$ (偏右) | $\delta > 0$ (左打) | 向左拉回 |
| 倒车     | $e_d > 0$ (偏左) | $\delta < 0$ (右打) | 向右拉回 |
| 倒车     | $e_d < 0$ (偏右) | $\delta > 0$ (左打) | 向左拉回 |

### 航向误差控制

航向误差校正确保车辆航向与轨迹切线方向一致：航向误差偏左（>0）时，需要顺时针转（负横摆角速度），前进时往右打，倒车时往左打。

| 速度方向 | 航向误差 ($e_{\phi}$) | 转向输出 ($\delta$) | 控制效果 |
| -------- | --------------------- | ------------------- | -------- |
| 前进     | $e_{\phi} > 0$ (偏左) | $\delta < 0$ (右打) | 顺时针转 |
| 前进     | $e_{\phi} < 0$ (偏右) | $\delta > 0$ (左打) | 逆时针转 |
| 倒车     | $e_{\phi} > 0$ (偏左) | $\delta > 0$ (左打) | 顺时针转 |
| 倒车     | $e_{\phi} < 0$ (偏右) | $\delta < 0$ (右打) | 逆时针转 |

## 注意事项

- 所有角度使用弧度，误差计算基于车辆质心。
- 控制器会自动裁剪转角到最大值（MAX_STEER）。
- 示例代码：参考 `simulation_runner_configurable.py` 中的仿真。
- 参考文献：Stanley 方法论文，PurePursuit 几何控制。

如有疑问，查看代码中的 docstring 或运行示例。
