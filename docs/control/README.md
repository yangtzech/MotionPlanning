# Control 目录代码与算法说明

本文档解释 Control 目录下路径跟踪控制器的坐标系、误差定义和控制逻辑。适用于 PurePursuit、Stanley 和 RearWheelFeedback 控制器。

## 坐标系定义

- **车头方向**：x 正方向为车头前进方向。
- **左侧/右侧**：y 正方向为车头左侧，y 负方向为车头右侧。
- **航向**：轨迹中的 yaw（航向角）始终指向车头方向，无论前进或倒车。
- **速度方向**：前进为正（>0），倒车为负（<0）。
- **曲率/半径方向**：往左为正（>0），往右为负（<0）。
- **转角请求 (delta)**：前轮转向角，往左为正（>0），往右为负（<0）。

## 误差定义

### 横向误差 (ed)

- **定义**：车辆当前位置到参考轨迹的垂直距离。
- **符号**：车辆在轨迹左侧时为正（>0），右侧时为负（<0）。无论前进或倒车，定义一致。
- **单位**：米。

### 航向误差 (e_phi)

- **定义**：车辆航向与参考轨迹切线方向的夹角。
- **符号**：车头朝着轨迹正方向左侧时为正（>0），右侧时为负（<0）。
- **单位**：弧度。

## 控制逻辑

### 横向误差控制

横向误差偏左（>0）时，往左打（delta >0）；偏右（<0）时，往右打（delta <0）。

| 速度方向  | 横向误差  | 转角请求 | 原因     |
| --------- | --------- | -------- | -------- |
| 前进 (>0) | 偏左 (>0) | 右 (<0)  | 纠正偏左 |
| 前进 (>0) | 偏右 (<0) | 左 (>0)  | 纠正偏右 |
| 倒车 (<0) | 偏左 (>0) | 右 (<0)  | 纠正偏左 |
| 倒车 (<0) | 偏右 (<0) | 左 (>0)  | 纠正偏右 |

### 航向误差控制

航向误差偏左（>0）时，需要顺时针转（负横摆角速度），前进时往右打，倒车时往左打。

| 速度方向  | 航向误差  | 转角请求 | 原因     |
| --------- | --------- | -------- | -------- |
| 前进 (>0) | 偏左 (>0) | 右 (<0)  | 顺时针转 |
| 前进 (>0) | 偏右 (<0) | 左 (>0)  | 逆时针转 |
| 倒车 (<0) | 偏左 (>0) | 左 (>0)  | 顺时针转 |
| 倒车 (<0) | 偏右 (<0) | 右 (<0)  | 逆时针转 |

## 注意事项

- 所有角度使用弧度，误差计算基于车辆质心。
- 控制器会自动裁剪转角到最大值（MAX_STEER）。
- 示例代码：参考 `simulation_runner_configurable.py` 中的仿真。
- 参考文献：Stanley 方法论文，PurePursuit 几何控制。

如有疑问，查看代码中的 docstring 或运行示例。

## Stanley

## PurePursuit

## RearWheelFeedback

后轮反馈控制器基于车辆后轮位置进行路径跟踪，适用于低速场景。 控制逻辑与前轮反馈类似，但误差计算基于后轮位置。
参考资料：

- [CSDN Blog on Rear-Wheel Feedback Control](https://blog.csdn.net/weixin_44519259/article/details/132795816)
- [Control Method - Rear-Wheel Position Feedback](https://zgh551.github.io/2020/02/26/控制算法-后轮位置反馈/)

## LQR

### 基于运动学模型



假设我们使用常见的自行车模型，误差状态为

$$
\delta \mathbf{x} = [e_d, \dot{e}_d, e_{phi}, \dot{e}_{phi}]^T
$$

 ，控制输入为

$$
\mathbf{u} = [\delta_f]
$$

，则误差状态方程可写为：

$$
\delta \dot{\mathbf{x}} = \mathbf{F} \delta \mathbf{x} + \mathbf{G} \mathbf{w}
$$

其中：

$$
\mathbf{F} = 
\begin{bmatrix}
0 & 0 & -v \sin\theta & \cos\theta \\
0 & 0 & v \cos\theta & \sin\theta \\
0 & 0 & 0 & \frac{\tan \delta_f}{L} \\
0 & 0 & 0 & 0
\end{bmatrix},
\quad
\mathbf{G} = 
\begin{bmatrix}
0 & 0 \\
0 & 0 \\
0 & \frac{v}{L \cos^2 \delta_f} \\
1 & 0
\end{bmatrix}
$$

这里：

- \( L \) 为轴距，
- \( \mathbf{w} \) 为过程噪声。

如果您有具体的模型形式或参数需要调整，请提供更多细节，我可以为您进一步定制 LaTeX 代码。
